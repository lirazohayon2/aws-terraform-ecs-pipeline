name: cd

on:
  workflow_run:
    workflows: ["ci"]
    types: [completed]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: "968196829773"
  PROJECT_NAME: "devops-project"
  ECS_CLUSTER: "devops-project-cluster"

jobs:
  cd_api:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::968196829773:role/devops-project-github-actions
          aws-region: us-east-1

      - name: Update API service task definition to new image
        run: |
          set -euo pipefail
          IMAGE_TAG=${{ github.event.workflow_run.head_sha }}
          NEW_IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/${PROJECT_NAME}-api:$IMAGE_TAG"
          SERVICE_NAME="${PROJECT_NAME}-api"

          TASK_DEF_ARN=$(aws ecs describe-services \
            --cluster "$ECS_CLUSTER" \
            --services "$SERVICE_NAME" \
            --query "services[0].taskDefinition" \
            --output text)

          aws ecs describe-task-definition \
            --task-definition "$TASK_DEF_ARN" \
            --query "taskDefinition" > taskdef.json

          jq --arg IMG "$NEW_IMAGE" '
            del(
              .taskDefinitionArn,
              .revision,
              .status,
              .requiresAttributes,
              .compatibilities,
              .registeredAt,
              .registeredBy
            )
            | .containerDefinitions[0].image = $IMG
          ' taskdef.json > taskdef-new.json

          NEW_TD_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://taskdef-new.json \
            --query "taskDefinition.taskDefinitionArn" \
            --output text)

          aws ecs update-service \
            --cluster "$ECS_CLUSTER" \
            --service "$SERVICE_NAME" \
            --task-definition "$NEW_TD_ARN"

          aws ecs wait services-stable \
            --cluster "$ECS_CLUSTER" \
            --services "$SERVICE_NAME"

  cd_worker:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::968196829773:role/devops-project-github-actions
          aws-region: us-east-1

      - name: Update Worker service task definition to new image
        run: |
          set -euo pipefail
          IMAGE_TAG=${{ github.event.workflow_run.head_sha }}
          NEW_IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/${PROJECT_NAME}-worker:$IMAGE_TAG"
          SERVICE_NAME="${PROJECT_NAME}-worker"

          TASK_DEF_ARN=$(aws ecs describe-services \
            --cluster "$ECS_CLUSTER" \
            --services "$SERVICE_NAME" \
            --query "services[0].taskDefinition" \
            --output text)

          aws ecs describe-task-definition \
            --task-definition "$TASK_DEF_ARN" \
            --query "taskDefinition" > taskdef.json

          jq --arg IMG "$NEW_IMAGE" '
            del(
              .taskDefinitionArn,
              .revision,
              .status,
              .requiresAttributes,
              .compatibilities,
              .registeredAt,
              .registeredBy
            )
            | .containerDefinitions[0].image = $IMG
          ' taskdef.json > taskdef-new.json

          NEW_TD_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://taskdef-new.json \
            --query "taskDefinition.taskDefinitionArn" \
            --output text)

          aws ecs update-service \
            --cluster "$ECS_CLUSTER" \
            --service "$SERVICE_NAME" \
            --task-definition "$NEW_TD_ARN"

          aws ecs wait services-stable \
            --cluster "$ECS_CLUSTER" \
            --services "$SERVICE_NAME"

  smoke_test:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    needs: [cd_api, cd_worker]
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::968196829773:role/devops-project-github-actions
          aws-region: us-east-1

      - name: Smoke test /health via ALB DNS
        run: |
          set -euo pipefail
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --names "${PROJECT_NAME}-alb" \
            --query "LoadBalancers[0].DNSName" \
            --output text)

          curl -fsS "http://$ALB_DNS/health"
